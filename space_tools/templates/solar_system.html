<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Solar System Light Path</title>
    <style>
      body {
        background: black;
        color: white;
        font-family: sans-serif;
      }
      canvas {
        background: black;
        display: block;
        margin: 0 auto;
      }
      #controls {
        text-align: center;
        margin-top: 0.5rem;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas" width="800" height="800"></canvas>
    <div id="controls">
      Planet A: <select id="selectA"></select>
      Planet B: <select id="selectB"></select>
      <br />
      Distortion: <input type="range" id="distortion" min="1" max="10" value="1" />
    </div>
    <div id="info" style="text-align: center; margin-top: 0.5rem">
      Select planets to view light path
    </div>
    <script>
      const PLANETS = {{ planets | tojson }};

      const C_KM_PER_S = 299792.458;
      const AU_KM = 149597870;
      const C_M_PER_S = C_KM_PER_S * 1000;
      const AU_M = AU_KM * 1000;
      const MU_SUN = 1.32712440018e20;

      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const selectA = document.getElementById("selectA");
      const selectB = document.getElementById("selectB");
      const info = document.getElementById("info");
      const distortionSlider = document.getElementById("distortion");

      let planetPositions = {};
      let selectionA = PLANETS[2].name; // Earth
      let selectionB = PLANETS[3].name; // Mars

      PLANETS.forEach((p) => {
        const optionA = document.createElement("option");
        optionA.value = p.name;
        optionA.textContent = p.name;
        selectA.appendChild(optionA);

        const optionB = document.createElement("option");
        optionB.value = p.name;
        optionB.textContent = p.name;
        selectB.appendChild(optionB);
      });
      selectA.value = selectionA;
      selectB.value = selectionB;

      selectA.addEventListener("change", () => {
        selectionA = selectA.value;
        draw();
      });
      selectB.addEventListener("change", () => {
        selectionB = selectB.value;
        draw();
      });
      distortionSlider.addEventListener("input", () => draw());

      function daysSinceEpoch() {
        const epoch = new Date("2000-01-01T00:00:00Z");
        const now = new Date();
        const msPerDay = 86400000;
        return (now - epoch) / msPerDay;
      }

      function position(planet, days) {
        const angle = (2 * Math.PI * days) / planet.period_days;
        const x = planet.orbit_au * Math.cos(angle);
        const y = planet.orbit_au * Math.sin(angle);
        return [x, y];
      }

      function shapiroDelay(r1_m, r2_m, R_m) {
        const denom = r1_m + r2_m - R_m;
        if (denom <= 0) return 0;
        return (
          (2 * MU_SUN) / Math.pow(C_M_PER_S, 3)
        ) * Math.log((r1_m + r2_m + R_m) / denom);
      }

      function lightPath(nameA, nameB) {
        const [ax_au, ay_au] = planetPositions[nameA].au;
        const [bx_au, by_au] = planetPositions[nameB].au;
        const r1_m = Math.hypot(ax_au, ay_au) * AU_M;
        const r2_m = Math.hypot(bx_au, by_au) * AU_M;
        const R_m = Math.hypot(ax_au - bx_au, ay_au - by_au) * AU_M;
        let delay = shapiroDelay(r1_m, r2_m, R_m);
        const distortion = Number(distortionSlider.value) - 1;
        delay *= Math.exp(distortion);
        const geom_m = R_m;
        const proper_m = R_m + C_M_PER_S * delay;
        const geom_s = geom_m / C_M_PER_S;
        const proper_s = proper_m / C_M_PER_S;
        return {
          geom_km: geom_m / 1000,
          proper_km: proper_m / 1000,
          geom_s,
          proper_s,
        };
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        planetPositions = {};
        const width = canvas.width;
        const cx = width / 2;
        const cy = width / 2;
        const baseScale = width / (2 * PLANETS[PLANETS.length - 1].orbit_au * 1.1);
        const days = daysSinceEpoch();

        // Sun
        ctx.fillStyle = "yellow";
        ctx.beginPath();
        ctx.arc(cx, cy, 10, 0, 2 * Math.PI);
        ctx.fill();

        PLANETS.forEach((p) => {
          const r = p.orbit_au * baseScale;
          ctx.strokeStyle = "white";
          ctx.beginPath();
          ctx.arc(cx, cy, r, 0, 2 * Math.PI);
          ctx.stroke();

          const [x_au, y_au] = position(p, days);
          const x = cx + x_au * baseScale;
          const y = cy + y_au * baseScale;
          ctx.fillStyle = p.color;
          ctx.beginPath();
          ctx.arc(x, y, 6, 0, 2 * Math.PI);
          ctx.fill();
          ctx.fillStyle = "white";
          ctx.fillText(p.name, x + 8, y);
          planetPositions[p.name] = { x, y, au: [x_au, y_au] };
        });

        drawConnection();
      }

      function drawConnection() {
        if (selectionA && selectionB && selectionA !== selectionB) {
          const { x: ax, y: ay } = planetPositions[selectionA];
          const { x: bx, y: by } = planetPositions[selectionB];
          ctx.strokeStyle = "cyan";
          ctx.beginPath();
          ctx.moveTo(ax, ay);
          ctx.lineTo(bx, by);
          ctx.stroke();

          const mid_x = (ax + bx) / 2;
          const mid_y = (ay + by) / 2;
          const bend = 0.2 * (Number(distortionSlider.value) - 1);
          const cx_canvas = canvas.width / 2;
          const cy_canvas = canvas.height / 2;
          const ctrl_x = mid_x + (cx_canvas - mid_x) * bend;
          const ctrl_y = mid_y + (cy_canvas - mid_y) * bend;
          ctx.strokeStyle = "magenta";
          ctx.beginPath();
          ctx.moveTo(ax, ay);
          ctx.quadraticCurveTo(ctrl_x, ctrl_y, bx, by);
          ctx.stroke();

          const { geom_km, proper_km, geom_s, proper_s } = lightPath(
            selectionA,
            selectionB
          );
          info.textContent =
            `Geom: ${geom_km.toLocaleString(undefined, { maximumFractionDigits: 0 })} km ` +
            `(${(geom_s / 60).toFixed(2)} min)  |  Proper: ${proper_km.toLocaleString(undefined, { maximumFractionDigits: 0 })} km ` +
            `(${(proper_s / 60).toFixed(2)} min)`;
        } else {
          info.textContent = "Select planets to view light path";
        }
      }

      draw();
    </script>
  </body>
</html>

